define(["jquery","core/ajax","core/notification","core/modal_factory","core/chartjs"],function(e,t,s,i){return{init:function(){var r="",a=null,o=fetchtinglastusage=fetchtingplugins=sendingemail=!1;function n(e,t){return(t*e/100).toFixed(2)+"G/"+t.toFixed(2)+"G"}e(".progress-bar").bind("progress-status",function(t,s){let i="bg-danger";s<30?i="bg-success":s<80&&(i="bg-warning"),e(this).removeClass("bg-success bg-warning bg-danger").addClass(i)});var l=function(){o||(o=!0,t.call([{methodname:"block_edwiser_site_monitor_get_live_status",args:{}}])[0].done(function(t){e("#esm_cpu_usage_bar").css("width",t.cpu+"%").trigger("progress-status",[t.cpu]),e("#esm_memory_usage_bar").css("width",t.memory+"%").trigger("progress-status",[t.memory]),e("#esm_storage_usage_bar").css("width",t.storage+"%").trigger("progress-status",[t.storage]),e("#esm_cpu_usage_label").text(t.cpu+"%"),e("#esm_memory_usage_label").text(t.memory+"% ("+n(t.memory,totalmemory)+")"),e("#esm_storage_usage_label").text(t.storage+"% ("+n(t.storage,totalstorage)+")"),e("#esm_live_users_label").text(t.liveusers),o=!1}).fail(function(e){alert(e.message),o=!1}))},d=function(){if(!fetchtinglastusage){fetchtinglastusage=!0,e(".edwiser_site_monitor #edwiser_site_monitor_last_24_hours_usage .edwiser-server-monitor-loader").addClass("show");var s=e("#esm_usage_date_selector").val()||0;t.call([{methodname:"block_edwiser_site_monitor_get_last_24_hours_usage",args:{timestamp:s}}])[0].done(function(t){if(fetchtinglastusage=!1,e(".edwiser_site_monitor #edwiser_site_monitor_last_24_hours_usage .edwiser-server-monitor-loader").removeClass("show"),null!=a)return a.data.labels=JSON.parse(t.time),a.data.datasets[0].data=JSON.parse(t.cpu),a.data.datasets[1].data=JSON.parse(t.memory),a.data.datasets[2].data=JSON.parse(t.storage),void a.update();let s={type:"line",data:{labels:JSON.parse(t.time),datasets:[{label:M.util.get_string("cpuusage","block_edwiser_site_monitor"),data:JSON.parse(t.cpu),borderColor:"#ff4c52",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1},{label:M.util.get_string("memoryusage","block_edwiser_site_monitor"),data:JSON.parse(t.memory),borderColor:"#11c26d",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1},{label:M.util.get_string("storageusage","block_edwiser_site_monitor"),data:JSON.parse(t.storage),borderColor:"#667afa",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1}]},options:{scales:{yAxes:[{position:"right",ticks:{beginAtZero:!1},gridLines:{display:!1},scaleLabel:{display:!0,labelString:M.util.get_string("yaxistitle","block_edwiser_site_monitor")}}],xAxes:[{gridLines:{display:!1},scaleLabel:{display:!0,labelString:M.util.get_string("xaxistitle","block_edwiser_site_monitor")}}]},tooltips:{position:"nearest",mode:"index",intersect:!1,callbacks:{label:function(e,t){var s=t.datasets[e.datasetIndex].label||"";switch(s&&(s+=": "),s+=e.yLabel+"%",e.datasetIndex){case 1:s+=" ("+n(e.yLabel,totalmemory)+")";break;case 2:s+=" ("+n(e.yLabel,totalstorage)+")"}return s}}}}};a=new Chart(e("#esm_usage_chart")[0].getContext("2d"),s)}).fail(function(t){e(".edwiser_site_monitor #edwiser_site_monitor_last_24_hours_usage .edwiser-server-monitor-loader").removeClass("show"),alert(t.message),fetchtinglastusage=!1})}},_=function(){fetchtingplugins||(fetchtingplugins=!0,e(".edwiser_site_monitor #edwiser_site_monitor_plugins .edwiser-server-monitor-loader").addClass("show"),t.call([{methodname:"block_edwiser_site_monitor_get_plugins_update",args:{}}])[0].done(function(t){e(".edwiser_site_monitor #edwiser_site_monitor_plugins .edwiser-server-monitor-loader").removeClass("show"),e(".edwiser_site_monitor #edwiser_site_monitor_plugins .server-plugins-list").html(t.plugins),e(".edwiser_site_monitor .lasttimefetched").text(t.lasttimefetched),fetchtingplugins=!1}).fail(function(t){e(".edwiser_site_monitor #edwiser_site_monitor_plugins .edwiser-server-monitor-loader").removeClass("show"),s.exception(t),fetchtingplugins=!1}))},c=function(r){sendingemail||(sendingemail=!0,e(".edwiser_site_monitor #edwiser_site_monitor_contactus .edwiser-server-monitor-loader").addClass("show"),t.call(r)[0].done(function(t){e(".edwiser_site_monitor #edwiser_site_monitor_contactus .edwiser-server-monitor-loader").removeClass("show");var s=e("#create-modal");i.create({title:t.header,body:t.message},s).done(function(e){e.header.addClass(t.status?"bg-success":"bg-danger"),e.header.children().addClass("text-white"),e.show()}),t.status&&(e("#contactus_form button").prop("disabled",!0),e("#contactus_form_succes").addClass("show")),sendingemail=!1}).fail(function(t){e(".edwiser_site_monitor #edwiser_site_monitor_contactus .edwiser-server-monitor-loader").removeClass("show"),s.exception(t),sendingemail=!1}))};e(document).ready(function(){r=setInterval(function(){l()},1e3*refreshrate),e("#esm_usage_date_selector").change(function(){d()}),e(".edwiser_site_monitor .nav-link").click(function(){switch(e(this).data("container")){case"edwiser_site_monitor_view_live_status":r=setInterval(function(){l()},1e3*refreshrate);break;case"edwiser_site_monitor_last_24_hours_usage":d(),clearInterval(r);break;case"edwiser_site_monitor_plugins":""==e.trim(e(".edwiser_site_monitor .server-plugins-list").text())&&e(".edwiser_site_monitor .refresh-plugin-list").trigger("click");case"edwiser_site_monitor_recommendation":case"edwiser_site_monitor_contactus":clearInterval(r)}}),e("body").on("click",".edwiser_site_monitor .refresh-plugin-list",function(){_()}).on("click",".edwiser_site_monitor .edwiser-plugin-filter",function(t){t.preventDefault(),e(this).parent(".server-plugins-list").removeClass("all edwiser other update").addClass(e(this).data("filter")),e("#plugins-control-panel").removeClass("all edwiser other update").addClass(e(this).data("filter")),e(".edwiser-plugins-current-list").text(e(this).data("heading")),e(".edwiser-plugin-filter").removeClass("active"),e(this).addClass("active")}).on("click",".showchangelog",function(t){t.preventDefault();var s=e("#create-modal");i.create({title:M.util.get_string("changelog","block_edwiser_site_monitor"),body:e(this).data("log").changelog},s).done(function(e){e.show()})}),e("#contactus_form").submit(function(t){t.preventDefault();var s=e(this).serializeArray(),i={methodname:"block_edwiser_site_monitor_send_contactus_email",args:{}};e.each(s,function(e,t){i.args[t.name]=t.value}),c([i])})})}}});